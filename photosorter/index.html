<!--todo: could update prototype for all properties, open keybindings after upload-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <title>Photosorter</title>
    <link rel="stylesheet" href="/css/stylesheet.css">
    <link rel="stylesheet" href="/photoswipe/dist/photoswipe.css">
    <link href="https://fonts.googleapis.com/css?family=Merriweather:300&display=swap" rel="stylesheet">
    <style>
    </style>
</head>
<body>
<div id="drag-target">
    <span id="drag-text">Drop to upload</span>
</div>
<div id="snackbar"></div>
<div class="center-parent">
    <div class="center-child">
        <h1>Jorts PhotoSorter</h1>
        <p class="subtitle">
            Sort within your browser!
        </p>
        <div id="log-bar">
        </div>

        <section class="c-section" id="upload-section">
            <div class="c-section-title-row">
                <img class="c-section-button" src="/img/right.svg" height="20em" alt="Open button">
                <h2 class="c-section-title">1: Upload files</h2>
            </div>
            <div class="c-section-content">
                Upload or drop files to sort.
                <br>

                <div class="upload-btn-wrapper">
                    <button class="link-button link-button-inverse" id="folder-upload-btn">Upload folder</button>
                    <input type="file" id="folder-upload" webkitdirectory directory multiple>
                </div>
                <div class="upload-btn-wrapper">
                    <button class="link-button link-button-inverse" id="upload-btn">Upload files</button>
                    <input id="file-upload" type="file" name="myfile" multiple/>
                </div>
                <br>
                <div id="upload-info"></div>
                <div id="previous-upload-info"></div>
            </div>
        </section>


        <section class="c-section" id="keybinding-section">
            <div class="c-section-title-row">
                <img class="c-section-button" src="/img/right.svg" height="20em" alt="Open button">
                <h2 class="c-section-title">2: Folders</h2>
            </div>
            <div class="c-section-content">
                Enter the names of the folders to sort to.
                <div class="flex-table" id="keybindings-table">
                    <div class="flex-table-row flex-table-first-row">
                        <div class="flex-table-cell flex-table-small-cell">Hotkey</div>
                        <div class="flex-table-cell flex-table-big-cell">Folder</div>
                        <!--hehe-->
                        <button class="flex-table-cell flex-table-small-cell invisible-button"
                                id="add-keybinding-button"><span
                                style="color: transparent;  text-shadow: 0 0 0 green; transform: rotate(45deg); display: inline-block">‚ùå</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section class="c-section" id="sort-section">
            <div class="c-section-title-row">
                <img class="c-section-button" src="/img/right.svg" height="20em" alt="Open button">
                <h2 class="c-section-title">3: Sort</h2>
            </div>
            <div class="c-section-content">
                Click to open the gallery to start sorting!<br>
                <button class="link-button" id="open-gallery-button" style="visibility: hidden">Start sorting</button>
            </div>
        </section>

        <section class="c-section" id="apply-windows">
            <div class="c-section-title-row">
                <img class="c-section-button" src="/img/right.svg" height="20em" alt="Open button">
                <h2 class="c-section-title">4: Apply sorting - Windows</h2>
            </div>
            <div class="c-section-content" id="windows-export"></div>
            <section class="c-section" id="apply-linux">
                <div class="c-section-title-row">
                    <img class="c-section-button" src="/img/right.svg" height="20em" alt="Open button">
                    <h2 class="c-section-title">4: Apply sorting - Linux / MacOS</h2>
                </div>
                <div class="c-section-content" id="linux-export"></div>
            </section>

            <section class="c-section" id="apply-universal">
                <div class="c-section-title-row">
                    <img class="c-section-button" src="/img/right.svg" height="20em" alt="Open button">
                    <h2 class="c-section-title">4: Download sorting (universal)</h2>
                </div>
                <div class="c-section-content">
                    Download a .zip file with the items sorted.
                    This is slower and takes more space compared to applying the sort with commands.
                    The zip will contain all the files you just uploaded.
                    <br>
                    <button id="download-universal-sort" class="link-button link-button-inverse">Zip file</button>
                </div>
            </section>

            <section class="c-section" id="advanced-options-section">
                <div class="c-section-title-row">
                    <img class="c-section-button" src="/img/right.svg" height="20em" alt="Open button">
                    <h2 class="c-section-title">Advanced options</h2>
                </div>
                <div class="c-section-content">
                    <div class="vertical">
                        <button id="clear-mappings-button">Clear sorts</button>
                        <button id="example-images-button">Load example images</button>
                        <button id="example-keybindings-button">Load example keybindings</button>
                        <button id="clear-storage-button">Clear all website data</button>
                    </div>
                </div>
            </section>

    </div>

    <div class="footer" id="sort-footer" style="visibility: hidden">
        <div id="filename-display">Filename</div>
        <div id="mapped-folder-display"></div>
        <div class="footer-keybindings" id="footer-keybindings"></div>
    </div>


</div>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script type="module">
    import PhotoSwipeLightbox from '/photoswipe/dist/photoswipe-lightbox.esm.js';
    import PhotoSwipeVideoPlugin from '/photoswipe/dist/photoswipe-video-plugin.esm.js';
    // import JSZip from '/jszip/dist/jszip.min.js';


    let pswp = null; // photoswipe instance, it is non-null if open
    let lastTimeoutId = null; // used to log to user with a timeout
    let loadedCount = 0; // keep track of how many uploaded items are loaded for gallery
    let dragCounter = 0; // file drop: keep count of drag events to identify fake dragleave events

    function logToUser(msg, timeout = 3000) {
        clearTimeout(lastTimeoutId);
        if (timeout > 0) {
            let toastElement = document.getElementById("snackbar");
            toastElement.textContent = msg
            toastElement.classList.add("show")
            toastElement.style.visibility = "visible"
            let duration = timeout / 1000 - 0.5
            toastElement.style.animation = `fadein 0.5s, fadeout 0.5s ${duration}s`
            lastTimeoutId = setTimeout(function () {
                toastElement.classList.remove("show");
                toastElement.style.visibility = "hidden"
            }, timeout);
        }
    }

    function shakeElement(element) {
        element.classList.add("shake");

        setTimeout(function () {
            element.classList.remove("shake");
        }, 400);
    }

    function fileObjectToGalleryInputItem(file) {
        let item = {}
        const itemHtml = `<div class="custom-html-slide">${file.name}</div>`; // fallback if file can't be displayed
        const fileType = file['type'];
        // load image
        const urlObj = URL.createObjectURL(file);

        if (fileType.includes("image")) {
            item.src = urlObj;
            let img = new Image();
            img.onload = function () {
                ++loadedCount
                item.width = img.width;
                item.height = img.height;
            };
            img.src = urlObj; //this loads the image, triggering the above event
        }
        // load video (takes long)
        else if (fileType.includes("video")) {
            let video = document.createElement("video");
            video.addEventListener("loadeddata", function () {
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    // if 0x0: browser does not support the video type, just show filename
                    item.html = itemHtml;
                    ++loadedCount
                }
                else {
                    ++loadedCount
                    item.width = video.videoWidth;
                    item.height = video.videoHeight;
                    item.videoSrc = urlObj;
                    item.type = "video";
                    item.msrc = urlObj; // not needed but prevents error showing
                    item.src = urlObj; // not needed but added for item check and cleanliness
                }
            });
            video.src = urlObj; // this loads the video, triggering the above event
        }
        // fallback for remanining file types
        else {
            item.html = itemHtml;
            ++loadedCount
        }
        item.alt = file.name;
        return item;
    }

    function pollUntilTrue(condition, interval, timeout) {
        return new Promise((resolve, reject) => {
            const startTime = Date.now();
            const intervalId = setInterval(() => {
                const elapsedTime = Date.now() - startTime;
                if (condition()) {
                    clearInterval(intervalId);
                    resolve();
                }
                else if (elapsedTime >= timeout) {
                    clearInterval(intervalId);
                    reject(new Error(`Timeout of ${timeout}ms reached`));
                }
            }, interval);
        });
    }

    async function urlToImageFile(filename) {
        const width = 2400
        const height = 1600
        const url = `https://dummyimage.com/${width}x${height}/000000/ffffff&text=${filename}`
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const blob = new Blob([arrayBuffer]);
        let file = new File([blob], filename);
        file = new File([file], file.name, {type: "image/jpeg"}); //cant set it directly
        return file;
    }


    async function getMockUploadEvent() {
        const file1 = new File(["Hello, World!"], "hello.txt", {type: "text/plain"});

        const img1 = await urlToImageFile("landscape.jpg");
        const img2 = await urlToImageFile("face.jpg");
        const img3 = await urlToImageFile("flower.jpg");
        const img4 = await urlToImageFile("mom.jpg");
        const fileList = [img1, img2, img3, file1, img4];

        const mockEvent = {
            target: {
                files: fileList
            }
        };
        return mockEvent
    }

    function loadGalleryArguments(fileObjects) {
        // gallery needs dimensions of images etc, so we need to load them
        loadedCount = 0;
        let items = []
        fileObjects.forEach(fileObject => {
            let item = fileObjectToGalleryInputItem(fileObject);
            items.push(item);
        });
        return {
            dataSource: items,
            pswpModule: () => import('/photoswipe/dist/photoswipe.esm.js'),
            getViewportSizeFn: function (options, pswp) {
                // also see the paddingfn attribute, aso for each img possible
                return {
                    x: document.documentElement.clientWidth,
                    y: window.innerHeight * 0.9 //subtract the footer, which is 0.1vh
                };
            },

            showHideAnimationType: 'none',
            wheelToZoom: true, // enable mouse scroll zoom
            bgClickAction: "none", //don't close the gallery if clicked behind image

            //default copies: options set to the default value
            bgOpacity: 0.8,
            errorMsg: 'The item cannot be loaded',
            pinchToClose: true,
            closeOnVerticalDrag: true,
            padding: {top: 0, bottom: 0, left: 0, right: 0},
            indexIndicatorSep: ' / ',
        }
    }

    function naturalSortFileObjects(files) {
        //does not change anything if files are uploaded with the file manager set to sort by name
        return files.sort((fileA, fileB) => fileA.name.localeCompare(fileB.name, navigator.languages[0] || navigator.language, {
            numeric: true,
            ignorePunctuation: true
        }))
    }

    function createFooterKeybindingElement(key, folder) {
        let keybindingDiv = document.createElement("div")
        keybindingDiv.classList.add("footer-keybinding")

        let keyDiv = document.createElement("div")
        keyDiv.classList.add("footer-keybinding-key")
        keyDiv.textContent = key;

        let folderDiv = document.createElement("div")
        folderDiv.classList.add("footer-keybinding-folder")
        folderDiv.textContent = folder

        keybindingDiv.addEventListener("click", () => {
            applyKeybindingByKey(key)
        })

        keybindingDiv.appendChild(keyDiv)
        keybindingDiv.appendChild(folderDiv)
        return keybindingDiv;
    }

    function loadAndShowSortingFooter() {
        let keybindings = localStorage.getKeybindings()
        let footer = document.getElementById("footer-keybindings")
        keybindings.forEach(keybinding => {
            let keybindingDiv = createFooterKeybindingElement(keybinding.key, keybinding.folder)
            footer.appendChild(keybindingDiv)
        })
        document.getElementById("sort-footer").style.visibility = "visible"
    }


    function showMappingForCurrentItem(folder) {
        //show the user to what folder the current item open in the gallery is mapped to
        let mappedFolderDisplay = document.getElementById("mapped-folder-display")
        mappedFolderDisplay.textContent = folder

        let keybindings = localStorage.getKeybindings()
        let keybindingIndex = keybindings.findIndex(keybinding => keybinding.folder === folder);
        //if not found, index will be -1, so nothing will be highlighted
        let footerKeybindingsElement = document.getElementById("footer-keybindings")
        for (let i = 0; i < footerKeybindingsElement.childElementCount; i++) {
            let keybindingElement = footerKeybindingsElement.children[i]
            if (i === keybindingIndex) {
                keybindingElement.style.backgroundColor = "green"
            }
            else {
                keybindingElement.style.backgroundColor = "red"
            }
        }

    }

    function getIndexByFilename() {
        let filename = localStorage.getFilename()
        if (!filename) {
            return 0;
        }
        let uploads = localStorage.getUploads()
        if (uploads.length === 0) {
            return 0;
        }

        let index = uploads.findIndex(upload => upload === filename);
        if (index === -1) {
            console.log(`${filename} was not re-uploaded, using saved index instead as fallback.`)
            return localStorage.getIndex()
        }
        return index;
    }

    function galleryOpenedListener(lightbox) {
        console.log(`Gallery opened`);
        //pswp instance not available after lightbox.init()
        pswp = lightbox.pswp // fill the gallery instance variable for other functions to use and know gallery is open
        loadAndShowSortingFooter();
    }

    function galleryClosedListener() {
        console.log('Gallery closed');
        pswp = null; // clear the variable so other functions know the gallery is closed
        let footerKeybindingDiv = document.getElementById("footer-keybindings")
        footerKeybindingDiv.innerHTML = ""
        document.getElementById("sort-footer").style.visibility = "hidden"
        loadSortingExport()
    }

    function getMappedFolder(filename) {
        let mappings = localStorage.getMappings()
        if (Object.hasOwn(mappings, filename)) {
            let folder = mappings[filename]
            return folder
        }
        else {
            return null
        }
    }

    function gallerySlideChangedListener() {
        // called after the gallery has loaded the next slide
        let uploads = localStorage.getUploads()
        let filename = uploads[pswp.currIndex]
        localStorage.setFilename(filename)
        localStorage.setIndex(pswp.currIndex) // save as fallback
        document.getElementById("filename-display").innerText = filename
        let mappedFolder = getMappedFolder(filename)
        //if not found, folder will be undefined, which should not match anything
        showMappingForCurrentItem(mappedFolder)
    }

    function initGallery(options) {
        const lightbox = new PhotoSwipeLightbox(options);
        const videoPlugin = new PhotoSwipeVideoPlugin(lightbox, {});
        lightbox.on('change', () => {
            gallerySlideChangedListener()
        });
        lightbox.on('firstUpdate', () => {
            galleryOpenedListener(lightbox)
        });
        lightbox.on('close', () => {
            galleryClosedListener()
        });
        lightbox.init();
        let openGalleryButton = document.getElementById("open-gallery-button");
        openGalleryButton.onclick = () => {
            let indexToLoad = getIndexByFilename()
            lightbox.loadAndOpen(indexToLoad);
        };
        openGalleryButton.style.visibility = "visible";

    }


    function displayUploadInformation() {
        document.getElementById("previous-upload-info").innerHTML = "" //otherwise double information
        let infoEl = document.getElementById("upload-info")
        let uploadedFilenames = localStorage.getUploads()
        let mappedFilenames = Object.keys(localStorage.getMappings())
        let mappingsThatWorkOnThisUpload = mappedFilenames.filter(filename => uploadedFilenames.includes(filename))
        let clearSortsLink = document.createElement("a")
        clearSortsLink.classList.add("link")
        clearSortsLink.addEventListener("click", clearMappings)
        clearSortsLink.textContent = `Reset sorted items`
        infoEl.textContent = `You've uploaded ${uploadedFilenames.length} files, of which ${mappingsThatWorkOnThisUpload.length} are already sorted. `
        infoEl.appendChild(document.createElement("br"))
        infoEl.appendChild(clearSortsLink)
    }

    function handleUploadedFiles(fileObjects) {
        openSection("keybinding-section")
        openSection("sort-section")
        let uploadedFileObjects = Array.from(fileObjects);
        naturalSortFileObjects(uploadedFileObjects)
        let uploadedFilenames = uploadedFileObjects.map(fileObject => fileObject.name)
        localStorage.setUploads(uploadedFilenames)
        let uploadedFileUrls = uploadedFileObjects.map(fileObject => URL.createObjectURL(fileObject))
        localStorage.setUploadUrls(uploadedFileUrls)
        displayUploadInformation()
        logToUser(`Loading ${uploadedFileObjects.length} items...`);
        let options = loadGalleryArguments(uploadedFileObjects);

        //wait for gallery arguments to have all the dimensions before showing open button
        //could also show earlier, but not tested and user will experience stutters in gallery
        const condition = () => {
            //loadedCount is incremented in the listeners created in the loader function
            // not sure if concurrency might be a problem in the future
            logToUser(`Loaded ${loadedCount} / ${uploadedFileObjects.length}`, -1);
            return loadedCount >= uploadedFileObjects.length;
        }
        pollUntilTrue(condition, 200, 60000)
            .then((result) => {
                logToUser("Loaded items!") // clear progress bar
                initGallery(options)
            })
            .catch((error) => {
                logToUser(error)
            });
    }

    function addNewKeybinding() {
        let keybinding = {
            id: uid(), //unique id, so i dont have to check for duplicate keys / folders
            key: "üîë",
            folder: "other",
        }
        let keybindings = localStorage.getKeybindings()
        keybindings.push(keybinding)
        localStorage.setKeybindings(keybindings)
        appendToKeybindingTable(keybinding)
        return keybinding;
    }

    function updateKeybinding(keybinding) {
        let keybindings = localStorage.getKeybindings()
        let indexToUpdate = keybindings.findIndex((element) => element.id === keybinding.id);
        keybindings[indexToUpdate] = keybinding;
        localStorage.setKeybindings(keybindings);
    }

    function deleteKeybinding(id) {
        let keybindings = localStorage.getKeybindings()
        let indexToDelete = keybindings.findIndex((element) => element.id === id);
        keybindings.splice(indexToDelete, 1);
        localStorage.setKeybindings(keybindings)
    }

    function clearKeybindings() {
        //return true if keybindings were cleared
        // clear in storage
        let keybindings = localStorage.getKeybindings()
        if (!confirm(`Clear ${keybindings.length} keybindings?`)) {
            return false;
        }
        localStorage.setKeybindings([])

        // clear in DOM
        let keybindingRows = document.getElementsByClassName("flex-table-row")
        keybindingRows = Array.from(keybindingRows);
        keybindingRows.shift(); // don't remove the first element, the header
        keybindingRows.forEach(keybindingRow => keybindingRow.remove())
        return true;
    }


    function appendToKeybindingTable(keybinding) {
        const keybindingsContainer = document.getElementById('keybindings-table');

        const keybindingRow = document.createElement('div');
        keybindingRow.classList.add('flex-table-row');

        const hotkeyInput = document.createElement('button');
        hotkeyInput.classList.add('invisible-button');
        hotkeyInput.title = "Change key"
        hotkeyInput.classList.add('flex-table-cell');
        hotkeyInput.classList.add('flex-table-small-cell');
        hotkeyInput.textContent = keybinding.key;
        hotkeyInput.addEventListener("click", () => {
            console.log(`Waiting for user to press key to bind to folder '${keybinding.folder}'...`)
            hotkeyInput.textContent = "üëÇ"
            document.addEventListener("keydown", event => {
                if (event.key === "Escape") {
                    console.log("Bind cancelled.")
                    hotkeyInput.textContent = keybinding.key;
                    return;
                }
                hotkeyInput.textContent = event.key
                keybinding.key = event.key
                updateKeybinding(keybinding);
                console.log(`Set '${event.key}' as key for folder '${keybinding.folder}'`)
            }, {once: true})
        })


        const folderInput = document.createElement('input');
        folderInput.classList.add('flex-table-cell');
        folderInput.classList.add('flex-table-big-cell');
        folderInput.value = keybinding.folder;
        folderInput.addEventListener('input', function () {
            keybinding.folder = folderInput.value;
            updateKeybinding(keybinding)
        });

        const deleteButton = document.createElement('button');
        deleteButton.classList.add('invisible-button');
        deleteButton.classList.add('flex-table-cell');
        deleteButton.classList.add('flex-table-small-cell');
        deleteButton.textContent = '‚ùå';
        deleteButton.title = "Delete"
        deleteButton.addEventListener('click', () => {
            deleteKeybinding(keybinding.id);
            keybindingRow.remove();
        });

        keybindingRow.appendChild(hotkeyInput);
        keybindingRow.appendChild(folderInput);
        keybindingRow.appendChild(deleteButton);

        keybindingsContainer.appendChild(keybindingRow);
    }

    const uid = function () {
        return Date.now().toString(36) + Math.random().toString(36).substring(2);
    }

    function loadKeybindingTable() {
        let keybindings = localStorage.getKeybindings()
        if (keybindings.length === 0) {
            return;
        }
        keybindings.forEach(keybinding => {
            appendToKeybindingTable(keybinding)
        })
    }

    function mapToFolder(folder) {
        //applies a keybinding to the current item open in the gallery
        let filename = localStorage.getFilename()
        console.log(`Move ${filename} to ${folder}`)
        let mappings = localStorage.getMappings()
        mappings[filename] = folder
        localStorage.setMappings(mappings)
    }

    function applyKeybindingByKey(key) {
        if (!pswp) {
            //gallery not open
            return;
        }
        let keybindings = localStorage.getKeybindings()
        let keybindingMatchIndex = keybindings.findIndex(keybinding => keybinding.key === key)

        if (keybindingMatchIndex === -1) {
            //key not bound to any keybinding
            return;
        }
        let keybinding = keybindings[keybindingMatchIndex]
        mapToFolder(keybinding.folder)

        let footerKeybindingElement = document.getElementById("footer-keybindings")
        shakeElement(footerKeybindingElement.children[keybindingMatchIndex])

        pswp.next()
    }

    async function loadExampleImages() {
        let mockEvent = await getMockUploadEvent()
        onUploadListener(mockEvent)
    }

    function getExampleKeybindings() {
        let keybindings = []
        keybindings.push({id: "id1", key: "p", folder: "people"})
        keybindings.push({id: "id2", key: "l", folder: "landscapes"})
        keybindings.push({id: "id3", key: "f", folder: "flower-folder"})
        keybindings.push({id: "id4", key: "o", folder: "other"})
        return keybindings;
    }

    function setExampleKeybindings() {
        if (clearKeybindings()) {
            localStorage.setKeybindings(getExampleKeybindings())
            loadKeybindingTable()
        }
    }

    function clearStorage() {
        if (!confirm("Clear all saved data?")) {
            return;
        }
        localStorage.clear()
        location.reload()
    }

    function onUploadListener({target}) {
        if (!target.files || !target.files.length) {
            logToUser("No files selected.")
            return;
        }
        handleUploadedFiles(target.files)
    }

    function clearMappings() {
        let mappings = localStorage.getMappings()
        if (!confirm(`Clear ${Object.keys(mappings).length} sorted items?`)) {
            return;
        }
        localStorage.setMappings({})
        displayUploadInformation()
        loadSortingExport()
    }

    function downloadTextAsFile(filename, text) {
        let element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
    }


    function getUndoCommands(mv_cmd = "mv", delimiter = "/") {
        let mappings = localStorage.getMappings()
        let mappingKeys = Object.keys(mappings);
        let undoFileContent = ``

        mappingKeys.forEach(key => {
            undoFileContent += `${mv_cmd} ${mappings[key]}${delimiter}${key} .${delimiter}\n`
        })
        return undoFileContent
    }

    function getApplyCommands(mv_cmd = "mv", delimiter = "/") {
        let mappings = localStorage.getMappings()
        let mappingKeys = Object.keys(mappings);
        let mappingValues = Object.values(mappings)
        let uniqueMappingValues = mappingValues.filter((value, index, array) => array.indexOf(value) === index);
        let applyFileContent = ``

        uniqueMappingValues.forEach(value => {
            applyFileContent += `mkdir "${value}"\n`
        })

        mappingKeys.forEach(key => {
            applyFileContent += `${mv_cmd} "${key}" "${mappings[key]}${delimiter}"\n`
        })
        return applyFileContent
    }

    async function blobUrlToBlob(url){
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const blob = await response.blob();
            return blob;
        } catch (error) {
            console.log('Error converting URL to Blob:', error);
            return null;
        }
    }


    async function exportZip(){
        console.log("Download zip...")

        let zip = new JSZip();
        let mappings = localStorage.getMappings()
        let mappingKeys = Object.keys(mappings)
        let uploads = localStorage.getUploads()
        let uploadUrls = localStorage.getUploadUrls()

        for (let mappingKey of mappingKeys) {
            let index = uploads.indexOf(mappingKey)
            if (index < 0){
                console.log(`Mapped item was not uploaded: ${mappingKey}`)
                continue
            }
            let url = uploadUrls[index]
            let blob = await blobUrlToBlob(url)
            let folder = mappings[mappingKey]
            console.log(`${folder}/${mappingKey}`)

            zip.file(`${folder}/${mappingKey}`, blob, {binary: true})
        }
        zip.generateAsync({type: "blob"}).then(function (zip) {
            saveAs(zip, "sorted.zip");
        }, function (err) {
            logToUser("Error generating .zip file.")
        });
    }

    function setupListeners() {
        // file uploader
        let fileInput = document.getElementById("file-upload");
        fileInput.addEventListener("change", (event) => {
            onUploadListener(event)
        });


        // folder uploader
        let folderInput = document.getElementById("folder-upload");
        folderInput.addEventListener("change", (event) => {
            onUploadListener(event)
        });

        //page wide file drop
        const dragTarget = document.getElementById('drag-target');
        document.addEventListener('dragenter', function (event) {
            dragCounter++;
            dragTarget.classList.add('show');
        });
        document.addEventListener('dragleave', function (event) {
            dragCounter--;
            if (dragCounter === 0) {
                // Perform your actions here when leaving the drag area
                console.log("Leave")
                dragTarget.classList.remove('show');
            }
        });
        document.addEventListener('dragover', function (event) {
            event.preventDefault();
        });
        document.addEventListener('drop', function (event) {
            console.log(event)
            dragCounter = 0;
            event.preventDefault();
            dragTarget.classList.remove('show');
            if (event.dataTransfer.files.length === 0) {
                logToUser("No files dropped.")
                return;
            }
            handleUploadedFiles(event.dataTransfer.files)
        });

        //clear mappings / sorts button
        let clearMappingsButton = document.getElementById("clear-mappings-button")
        clearMappingsButton.addEventListener("click", () => clearMappings())

        //keybindings table
        let addKeybindingButton = document.getElementById("add-keybinding-button")
        addKeybindingButton.addEventListener("click", () => addNewKeybinding())
        // let clearKeybindingsButton = document.getElementById("clear-keybindings-button")
        // clearKeybindingsButton.addEventListener("click", () => clearKeybindings())

        // key listener for keybindings
        document.addEventListener("keydown", event => applyKeybindingByKey(event.key))

        //testing / example values loader buttons
        let exampleKeybindingsButton = document.getElementById("example-keybindings-button")
        exampleKeybindingsButton.addEventListener("click", () => setExampleKeybindings())
        let exampleImagesButton = document.getElementById("example-images-button")
        exampleImagesButton.addEventListener("click", async () => await loadExampleImages())
        let clearStorageButton = document.getElementById("clear-storage-button")
        clearStorageButton.addEventListener("click", () => clearStorage())

        //zip download
        let zipDownload = document.getElementById("download-universal-sort")
        zipDownload.addEventListener("click", async event => {
            await exportZip()
        })
    }


    function setupLocalStorageBindings() {
        Storage.prototype.setObject = function (key, value) {
            this.setItem(key, JSON.stringify(value));
        }
        Storage.prototype.getObject = function (key) {
            let value = this.getItem(key);
            return value && JSON.parse(value);
        }
        // keybindings: an array of objects, where each object is a keybinding object with attributes: key, folder
        Storage.prototype.getKeybindings = function () {
            return localStorage.getObject("keybindings") || []
        }
        Storage.prototype.setKeybindings = function (keybindings) {
            return localStorage.setObject("keybindings", keybindings)
        }
        // mappings: an object where each key is a filename, with as value the folder it needs to be moved to
        Storage.prototype.getMappings = function () {
            return localStorage.getObject("mappings") || {}
        }
        Storage.prototype.setMappings = function (mappings) {
            return localStorage.setObject("mappings", mappings)
        }
        // filename: a string of the name of the file the gallery is currently showing / where the gallery last left off
        Storage.prototype.getFilename = function () {
            return localStorage.getItem("filename")
        }
        Storage.prototype.setFilename = function (filename) {
            return localStorage.setItem("filename", filename)
        }
        // index: an int of the index of the item gallery, FALLBACK for filename
        Storage.prototype.getIndex = function () {
            return parseInt(localStorage.getItem("index") || 0)
        }
        Storage.prototype.setIndex = function (index) {
            return localStorage.setItem("index", index)
        }
        // uploads: an array of filenames of the uploaded files
        Storage.prototype.getUploads = function () {
            return localStorage.getObject("uploads") || []
        }
        Storage.prototype.setUploads = function (uploads) {
            return localStorage.setObject("uploads", uploads)
        }

        // file url uploads: an array of urls to the uploaded files
        Storage.prototype.getUploadUrls = function () {
            return localStorage.getObject("upload-urls") || []
        }
        Storage.prototype.setUploadUrls = function (uploadsUrls) {
            return localStorage.setObject("upload-urls", uploadsUrls)
        }

        // boolean storage, used for section state memory
        Storage.prototype.setBoolean = function (key, value) {
            this.setItem(key, value)
        }
        Storage.prototype.getBoolean = function (key) {
            let value = JSON.parse(this.getItem(key));
            return value;
        }
        Storage.prototype.toggleBoolean = function (key) {
            this.setBoolean(key, !this.getBoolean(key))
        }
    }

    function handleFirstVisit() {
        if (localStorage.getObject("keybindings") !== null) {
            console.log("You have visited this page earlier.")
            return;
        }
        console.log("Setting defaults for first visit.")

        // example keybindings
        localStorage.setKeybindings(getExampleKeybindings())

        // open export section for platform
        let platform = window.navigator.platform
        if (platform.toLowerCase().includes("win")) {
            openSection("apply-sort-section-windows")
            closeSection("apply-sort-section-linux")
        }
        else {
            openSection("apply-sort-section-linux")
            closeSection("apply-sort-section-windows")
        }
    }

    function showUserPreviousUploads() {
        let previousUploadInfo = document.getElementById("previous-upload-info")
        let uploadedFilenames = localStorage.getUploads()
        if (uploadedFilenames.length < 1) {
            return;
        }
        let mappedFilenames = Object.keys(localStorage.getMappings())
        let mappingsThatWorkOnThisUpload = mappedFilenames.filter(filename => uploadedFilenames.includes(filename))
        let p1 = `Previous time, you:<ul>`
        let p2 = `<li>Uploaded ${uploadedFilenames.length} files</li>`
        let p3 = `<li>Sorted ${mappingsThatWorkOnThisUpload.length} files</li>`
        let p4 = `</ul>`
        let p5 = `Reupload if you want to continue.`
        previousUploadInfo.innerHTML = p1 + p2 + p3 + p4 + p5
    }

    function openSection(sectionName) {
        let section = document.getElementById(sectionName)
        let sectionButton = section.querySelector("img")
        let sectionContent = section.querySelectorAll("div")[1]
        sectionContent.style.display = "block"
        sectionButton.style.transform = "rotate(90deg)"
        sectionContent.style.animation = "fadeIn 0.5s ease-out"
        localStorage.setBoolean(sectionName, true)
    }

    function closeSection(sectionName) {
        let section = document.getElementById(sectionName)
        let sectionButton = section.querySelector("img")
        let sectionContent = section.querySelectorAll("div")[1]
        sectionContent.style.display = "none"
        sectionButton.style.transform = "rotate(0deg)"
        localStorage.setBoolean(sectionName, false)
    }

    function applySectionStateFromStorage(sectionName) {
        let isOpen = localStorage.getBoolean(sectionName)
        if (isOpen) {
            openSection(sectionName)
        }
        else {
            closeSection(sectionName)
        }
    }

    function setupSection(sectionName) {
        let section = document.getElementById(sectionName)
        let sectionButton = section.querySelector("img")
        sectionButton = section.querySelector("div")
        sectionButton.addEventListener("click", () => {
            localStorage.toggleBoolean(sectionName)
            applySectionStateFromStorage(sectionName)
        })
        applySectionStateFromStorage(sectionName)
    }


    function setupSections() {
        let sections = document.querySelectorAll('.c-section')
        sections.forEach(section => {
            setupSection(section.id)
        })
        //always open upload section on refresh, because uploads are always gone
        openSection("upload-section")
    }

    function getExportSectionContent(commands, filename, step2 = "sort") {
        let container = document.createElement("div")

        //content
        let contentDisplay = document.createElement("pre")
        let content = `#1: open terminal in folder with uploaded files\n`
        content += `#2: paste these commands in to ${step2}\n\n`
        content += commands
        contentDisplay.innerHTML += content
        container.appendChild(contentDisplay)

        //copy button
        let copyButton = document.createElement("button")
        copyButton.classList.add("link-button", "link-button-inverse")
        copyButton.textContent = "Copy"
        copyButton.addEventListener("click", event => {
            navigator.clipboard.writeText(content);
            copyButton.textContent = "Copied!"
            copyButton.classList.remove("link-button-inverse")
            setTimeout(function () {
                copyButton.classList.add("link-button-inverse");
                copyButton.textContent = "Copy"
            }, 2000);
        })
        container.appendChild(copyButton)

        //download button
        let downloadButton = document.createElement("button")
        downloadButton.classList.add("link-button", "link-button-inverse")
        downloadButton.textContent = "Download"
        downloadButton.addEventListener("click", event => {
            downloadTextAsFile(filename, content)
        })
        container.appendChild(downloadButton)
        return container
    }

    function loadSortingExport() {
        let linuxSection = document.getElementById("linux-export")
        linuxSection.innerHTML = ""
        let linuxApplyDiv = getExportSectionContent(getApplyCommands(), "apply.sh", "sort")
        let title = document.createElement("h5")
        title.textContent = "Sort"
        linuxSection.appendChild(title)
        linuxSection.appendChild(document.createElement("h1"))
        linuxSection.appendChild(linuxApplyDiv)
        let linuxUndoDiv = getExportSectionContent(getUndoCommands(), "undo.sh", "undo sort")
        title = document.createElement("h5")
        title.textContent = "Undo sort"
        linuxSection.appendChild(title)
        linuxSection.appendChild(linuxUndoDiv)

        //windows
        let windowsSection = document.getElementById("windows-export")
        windowsSection.innerHTML = ""
        let windowsApplyDiv = getExportSectionContent(getApplyCommands("move", "\\"), "apply.bat", "sort")
        title = document.createElement("h5")
        title.textContent = "Sort"
        windowsSection.appendChild(title)
        windowsSection.appendChild(document.createElement("h1"))
        windowsSection.appendChild(windowsApplyDiv)
        let windowsUndoDiv = getExportSectionContent(getUndoCommands("move", "\\"), "undo.bat", "undo sort")
        title = document.createElement("h5")
        title.textContent = "Undo sort"
        windowsSection.appendChild(title)
        windowsSection.appendChild(windowsUndoDiv)
    }

    function onLoad() {
        setupLocalStorageBindings()
        showUserPreviousUploads()
        handleFirstVisit()
        loadKeybindingTable()
        loadSortingExport()
        setupSections()
        setupListeners()
    }


    onLoad();

</script>
</html>

