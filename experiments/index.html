<!--todo: could update prototype for all properties, open keybindings after upload-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <title>Experiments</title>
    <link rel="stylesheet" href="/css/stylesheet.css">
    <link rel="stylesheet" href="/photoswipe/dist/photoswipe.css">
    <link href="https://fonts.googleapis.com/css?family=Merriweather:300&display=swap" rel="stylesheet">
    <style>
        .custom-html-slide {
            font-size: 40px;
            line-height: 45px;
            max-width: 400px;
            width: 100%;
            padding: 0 20px;
            margin: 50px auto 0;
            color: #fff;
        }

        .footer {
            background: white;
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: 10vh;
            z-index: 10000000000000;
            display: grid;
            place-items: center;
        }

        #drag-target {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            pointer-events: none;
        }

        #drag-target.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #drag-text {
            font-size: 24px;
            color: #fff;
            background-color: #333;
            padding: 20px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<div id="drag-target">
    <span id="drag-text">Drop here to upload</span>
</div>
<div class="center-parent">

    <div class="center-child">
        <h1>Photosorter</h1>
        <div id="log-bar">
        </div>
        <div class="upload-btn-wrapper">
            <button class="link-button link-button-inverse" id="upload-btn">Upload items</button>
            <input id="file-upload" type="file" name="myfile" multiple/>
        </div>
        <div class="upload-btn-wrapper">
            <button class="link-button link-button-inverse" id="folder-upload-btn">Upload folder</button>
            <input type="file" id="folder-upload" webkitdirectory directory multiple>
        </div>
        <br>
        <button id="open-tests-button">Show tests</button>
        <div id="test-section" style="display: none">
            <button id="example-images-button">Load example images</button>
            <button id="example-keybindings-button">Load example keybindings</button>
            <button id="clear-storage-button">Clear all website data</button>
        </div>

        <br>
        <hr>
        <h2>Keybindings</h2>
        <div class="flex-table" id="keybindings-table">
            <div class="flex-table-row flex-table-first-row">
                <div class="flex-table-cell">Hotkey</div>
                <div class="flex-table-cell">Folder</div>
                <button class="link-button link-button-red" id="clear-keybindings-button">Clear</button>
            </div>
        </div>
        <button class="link-button" id="add-keybinding-button">Add</button>


        <br>
        <br>
        <hr>
        <br>
        <br>
        <button class="link-button" id="open-gallery-button" style="visibility: hidden">Start sorting</button>
    </div>
    <div class="footer" id="sort-footer" style="visibility: hidden">
        <div id="filename-display">Filename</div>
        <div id="mapped-folder-display"></div>
        <div class="footer-keybindings" id="footer-keybindings"></div>
    </div>


</div>

</body>
<script type="module">
    import PhotoSwipeLightbox from '/photoswipe/dist/photoswipe-lightbox.esm.js';
    import PhotoSwipeVideoPlugin from '/photoswipe/dist/photoswipe-video-plugin.esm.js';

    let pswp = null; // photoswipe instance, it is non-null if open
    let lastTimeoutId = null; // used to log to user with a timeout
    let loadedCount = 0; // keep track of how many uploaded items are loaded for gallery

    function logToUser(msg, timeout = 3000) {
        clearTimeout(lastTimeoutId);
        let msgBar = document.getElementById("log-bar");
        msgBar.innerText = msg;
        console.log(msgBar.innerText)
        if (timeout > 0) {
            lastTimeoutId = setTimeout(function () {
                msgBar.innerText = " ";
            }, timeout);
        }
    }

    function shakeElement(element) {
        element.classList.add("shake");

        setTimeout(function () {
            element.classList.remove("shake");
        }, 400);
    }

    function fileObjectToGalleryInputItem(file) {
        let item = {}
        const itemHtml = `<div class="custom-html-slide">${file.name}</div>`; // fallback if file can't be displayed
        const fileType = file['type'];
        // load image
        if (fileType.includes("image")) {
            const urlObj = URL.createObjectURL(file);
            item.src = urlObj;
            let img = new Image();
            img.onload = function () {
                ++loadedCount
                item.width = img.width;
                item.height = img.height;
            };
            img.src = urlObj; //this loads the image, triggering the above event
        }
        // load video (takes long)
        else if (fileType.includes("video")) {
            const urlObj = URL.createObjectURL(file);
            let video = document.createElement("video");
            video.addEventListener("loadeddata", function () {
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    // if 0x0: browser does not support the video type, just show filename
                    item.html = itemHtml;
                    ++loadedCount
                }
                else {
                    ++loadedCount
                    item.width = video.videoWidth;
                    item.height = video.videoHeight;
                    item.videoSrc = urlObj;
                    item.type = "video";
                    item.msrc = urlObj; // not needed but prevents error showing
                    item.src = urlObj; // not needed but added for item check and cleanliness
                }
            });
            video.src = urlObj; // this loads the video, triggering the above event
        }
        // fallback for remanining file types
        else {
            item.html = itemHtml;
            ++loadedCount
        }
        item.alt = file.name;
        return item;
    }

    function pollUntilTrue(condition, interval, timeout) {
        return new Promise((resolve, reject) => {
            const startTime = Date.now();
            const intervalId = setInterval(() => {
                const elapsedTime = Date.now() - startTime;
                if (condition()) {
                    clearInterval(intervalId);
                    resolve();
                }
                else if (elapsedTime >= timeout) {
                    clearInterval(intervalId);
                    reject(new Error(`Timeout of ${timeout}ms reached`));
                }
            }, interval);
        });
    }

    async function urlToImageFile(filename) {
        const width = 2400
        const height = 1600
        const url = `https://dummyimage.com/${width}x${height}/000000/ffffff&text=${filename}`
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const blob = new Blob([arrayBuffer]);
        let file = new File([blob], filename);
        file = new File([file], file.name, {type: "image/jpeg"}); //cant set it directly
        return file;
    }


    async function getMockUploadEvent() {
        const file1 = new File(["Hello, World!"], "hello.txt", {type: "text/plain"});

        const img1 = await urlToImageFile("landscape.jpg");
        const img2 = await urlToImageFile("face.jpg");
        const img3 = await urlToImageFile("flower.jpg");
        const img4 = await urlToImageFile("mom.jpg");
        const fileList = [img1, img2, img3, file1, img4];

        const mockEvent = {
            target: {
                files: fileList
            }
        };
        return mockEvent
    }

    function loadGalleryArguments(fileObjects) {
        // gallery needs dimensions of images etc, so we need to load them
        loadedCount = 0;
        let items = []
        fileObjects.forEach(fileObject => {
            let item = fileObjectToGalleryInputItem(fileObject);
            items.push(item);
        });
        return {
            dataSource: items,
            pswpModule: () => import('/photoswipe/dist/photoswipe.esm.js'),
            getViewportSizeFn: function (options, pswp) {
                // also see the paddingfn attribute, aso for each img possible
                return {
                    x: document.documentElement.clientWidth,
                    y: window.innerHeight * 0.9 //subtract the footer, which is 0.1vh
                };
            },

            showHideAnimationType: 'none',
            wheelToZoom: true, // enable mouse scroll zoom
            bgClickAction: "none", //don't close the gallery if clicked behind image

            //default copies: options set to the default value
            bgOpacity: 0.8,
            errorMsg: 'The item cannot be loaded',
            pinchToClose: true,
            closeOnVerticalDrag: true,
            padding: {top: 0, bottom: 0, left: 0, right: 0},
            indexIndicatorSep: ' / ',
        }
    }

    function naturalSortFileObjects(files) {
        return files.sort((fileA, fileB) => fileA.name.localeCompare(fileB.name, navigator.languages[0] || navigator.language, {
            numeric: true,
            ignorePunctuation: true
        }))
    }

    function createFooterKeybindingElement(key, folder) {
        let keybindingDiv = document.createElement("div")
        keybindingDiv.classList.add("footer-keybinding")

        let keyDiv = document.createElement("div")
        keyDiv.classList.add("footer-keybinding-key")
        keyDiv.textContent = key;

        let folderDiv = document.createElement("div")
        folderDiv.classList.add("footer-keybinding-folder")
        folderDiv.textContent = folder

        keybindingDiv.style.cursor = "pointer"
        keybindingDiv.addEventListener("click", () => {
            applyKeybindingByKey(key)
        })

        keybindingDiv.appendChild(keyDiv)
        keybindingDiv.appendChild(folderDiv)
        return keybindingDiv;
    }

    function loadAndShowSortingFooter() {
        let keybindings = localStorage.getKeybindings()
        let footer = document.getElementById("footer-keybindings")
        keybindings.forEach(keybinding => {
            let keybindingDiv = createFooterKeybindingElement(keybinding.key, keybinding.folder)
            footer.appendChild(keybindingDiv)
        })
        document.getElementById("sort-footer").style.visibility = "visible"
    }


    function showMappingForCurrentItem(folder) {
        //show the user to what folder the current item open in the gallery is mapped to
        let mappedFolderDisplay = document.getElementById("mapped-folder-display")
        mappedFolderDisplay.textContent = folder

        let keybindings = localStorage.getKeybindings()
        let keybindingIndex = keybindings.findIndex(keybinding => keybinding.folder === folder);
        //if not found, index will be -1, so nothing will be highlighted
        let footerKeybindingsElement = document.getElementById("footer-keybindings")
        for (let i = 0; i < footerKeybindingsElement.childElementCount; i++) {
            let keybindingElement = footerKeybindingsElement.children[i]
            if (i === keybindingIndex) {
                keybindingElement.style.backgroundColor = "green"
            }
            else {
                keybindingElement.style.backgroundColor = "red"
            }
        }

    }

    function getIndexByFilename() {
        let filename = localStorage.getFilename()
        if (!filename) {
            return 0;
        }
        let uploads = localStorage.getUploads()
        if (uploads.length === 0) {
            return 0;
        }

        let index = uploads.findIndex(upload => upload === filename);
        if (index === -1) {
            console.log(`${filename} was not re-uploaded, using saved index instead as fallback.`)
            return localStorage.getIndex()
        }
        return index;
    }

    function galleryOpenedListener(lightbox) {
        console.log(`Gallery opened`);
        //pswp instance not available after lightbox.init()
        pswp = lightbox.pswp // fill the gallery instance variable for other functions to use and know gallery is open
        loadAndShowSortingFooter();
    }

    function galleryClosedListener() {
        console.log('Gallery closed');
        pswp = null; // clear the variable so other functions know the gallery is closed
        let footerKeybindingDiv = document.getElementById("footer-keybindings")
        footerKeybindingDiv.innerHTML = ""
        document.getElementById("sort-footer").style.visibility = "hidden"
    }

    function getMappedFolder(filename) {
        let mappings = localStorage.getMappings()
        if (Object.hasOwn(mappings, filename)) {
            let folder = mappings[filename]
            return folder
        }
        else {
            return null
        }
    }

    function gallerySlideChangedListener() {
        // called after the gallery has loaded the next slide
        let uploads = localStorage.getUploads()
        let filename = uploads[pswp.currIndex]
        localStorage.setFilename(filename)
        localStorage.setIndex(pswp.currIndex) // save as fallback
        document.getElementById("filename-display").innerText = filename
        let mappedFolder = getMappedFolder(filename)
        //if not found, folder will be undefined, which should not match anything
        showMappingForCurrentItem(mappedFolder)
    }

    function initGallery(options) {
        const lightbox = new PhotoSwipeLightbox(options);
        const videoPlugin = new PhotoSwipeVideoPlugin(lightbox, {});
        lightbox.on('change', () => {
            gallerySlideChangedListener()
        });
        lightbox.on('firstUpdate', () => {
            galleryOpenedListener(lightbox)
        });
        lightbox.on('close', () => {
            galleryClosedListener()
        });
        lightbox.init();
        let openGalleryButton = document.getElementById("open-gallery-button");
        openGalleryButton.onclick = () => {
            let indexToLoad = getIndexByFilename()
            lightbox.loadAndOpen(indexToLoad);
        };
        openGalleryButton.style.visibility = "visible";

    }

    function processUploadedFiles(fileObjects) {
        let uploadedFileObjects = Array.from(fileObjects);
        naturalSortFileObjects(uploadedFileObjects) //does not change anything if files are uploaded with the file manager set to sort by name
        let uploadedFilenames = uploadedFileObjects.map(fileObject => fileObject.name)
        localStorage.setUploads(uploadedFilenames)
        logToUser(`Loading ${uploadedFileObjects.length} items...`);
        let options = loadGalleryArguments(uploadedFileObjects);

        //wait for gallery arguments to have all the dimensions before showing open button
        //could also show earlier, but not tested and user will experience stutters in gallery
        const condition = () => {
            //loadedCount is incremented in the listeners created in the loader function
            // not sure if concurrency might be a problem in the future
            logToUser(`Loaded ${loadedCount} / ${uploadedFileObjects.length}`, -1);
            return loadedCount >= uploadedFileObjects.length;
        }
        pollUntilTrue(condition, 200, 60000)
            .then((result) => {
                logToUser("Loaded items!") // clear progress bar
                initGallery(options)
            })
            .catch((error) => {
                logToUser(error)
            });
    }

    function addNewKeybinding() {
        let keybinding = {
            id: uid(), //unique id, so i dont have to check for duplicate keys / folders
            key: "🔑",
            folder: "other",
        }
        let keybindings = localStorage.getKeybindings()
        keybindings.push(keybinding)
        localStorage.setKeybindings(keybindings)
        appendToKeybindingTable(keybinding)
        return keybinding;
    }

    function updateKeybinding(keybinding) {
        let keybindings = localStorage.getKeybindings()
        let indexToUpdate = keybindings.findIndex((element) => element.id === keybinding.id);
        keybindings[indexToUpdate] = keybinding;
        localStorage.setKeybindings(keybindings);
    }

    function deleteKeybinding(id) {
        let keybindings = localStorage.getKeybindings()
        let indexToDelete = keybindings.findIndex((element) => element.id === id);
        keybindings.splice(indexToDelete, 1);
        localStorage.setKeybindings(keybindings)
    }

    function clearKeybindings() {
        //return true if keybindings were cleared
        // clear in storage
        let keybindings = localStorage.getKeybindings()
        if (!confirm(`Clear ${keybindings.length} keybindings?`)) {
            return false;
        }
        localStorage.setKeybindings([])

        // clear in DOM
        let keybindingRows = document.getElementsByClassName("flex-table-row")
        keybindingRows = Array.from(keybindingRows);
        keybindingRows.shift(); // don't remove the first element, the header
        keybindingRows.forEach(keybindingRow => keybindingRow.remove())
        return true;
    }


    function appendToKeybindingTable(keybinding) {
        const keybindingsContainer = document.getElementById('keybindings-table');

        const keybindingRow = document.createElement('div');
        keybindingRow.classList.add('flex-table-row');

        const hotkeyInput = document.createElement('button');
        hotkeyInput.classList.add('neutral-button');
        hotkeyInput.title = "Change key"
        hotkeyInput.classList.add('flex-table-cell');
        hotkeyInput.textContent = keybinding.key;
        hotkeyInput.addEventListener("click", () => {
            console.log(`Waiting for user to press key to bind to folder '${keybinding.folder}'...`)
            hotkeyInput.textContent = "👂"
            document.addEventListener("keydown", event => {
                if (event.key === "Escape") {
                    console.log("Bind cancelled.")
                    return;
                }
                hotkeyInput.textContent = event.key
                keybinding.key = event.key
                updateKeybinding(keybinding);
                console.log(`Set '${event.key}' as key for folder '${keybinding.folder}'`)
            }, {once: true})
        })


        const folderInput = document.createElement('input');
        folderInput.classList.add('flex-table-cell');
        folderInput.value = keybinding.folder;
        folderInput.addEventListener('input', function () {
            keybinding.folder = folderInput.value;
            updateKeybinding(keybinding)
        });

        const deleteButton = document.createElement('button');
        deleteButton.classList.add('neutral-button');
        deleteButton.classList.add('flex-table-cell');
        deleteButton.textContent = '❌';
        deleteButton.title = "Delete"
        deleteButton.addEventListener('click', () => {
            deleteKeybinding(keybinding.id);
            keybindingRow.remove();
        });

        keybindingRow.appendChild(hotkeyInput);
        keybindingRow.appendChild(folderInput);
        keybindingRow.appendChild(deleteButton);

        keybindingsContainer.appendChild(keybindingRow);
    }

    const uid = function () {
        return Date.now().toString(36) + Math.random().toString(36).substring(2);
    }

    function loadKeybindingTable() {
        let keybindings = localStorage.getKeybindings()
        if (keybindings.length === 0) {
            return;
        }
        keybindings.forEach(keybinding => {
            appendToKeybindingTable(keybinding)
        })
    }

    function mapToFolder(folder) {
        //applies a keybinding to the current item open in the gallery
        let filename = localStorage.getFilename()
        console.log(`Move ${filename} to ${folder}`)
        let mappings = localStorage.getMappings()
        mappings[filename] = folder
        localStorage.setMappings(mappings)
    }

    function applyKeybindingByKey(key) {
        if (!pswp) {
            //gallery not open
            return;
        }
        let keybindings = localStorage.getKeybindings()
        let keybindingMatchIndex = keybindings.findIndex(keybinding => keybinding.key === key)

        if (keybindingMatchIndex === -1) {
            //key not bound to any keybinding
            return;
        }
        let keybinding = keybindings[keybindingMatchIndex]
        mapToFolder(keybinding.folder)

        let footerKeybindingElement = document.getElementById("footer-keybindings")
        shakeElement(footerKeybindingElement.children[keybindingMatchIndex])

        pswp.next()
    }

    async function loadExampleImages() {
        let mockEvent = await getMockUploadEvent()
        onUploadListener(mockEvent)
    }

    function getExampleKeybindings() {
        let keybindings = []
        keybindings.push({id: "id1", key: "p", folder: "people"})
        keybindings.push({id: "id2", key: "l", folder: "landscapes"})
        keybindings.push({id: "id3", key: "f", folder: "flower-folder"})
        keybindings.push({id: "id4", key: "o", folder: "other"})
        return keybindings;
    }

    function setExampleKeybindings() {
        if (clearKeybindings()) {
            localStorage.setKeybindings(getExampleKeybindings())
            loadKeybindingTable()
        }
    }

    function clearStorage() {
        if (!confirm("Clear all saved data?")) {
            return;
        }
        localStorage.clear()
        location.reload()
    }

    function onUploadListener({target}) {
        if (!target.files || !target.files.length) {
            logToUser("No files selected.")
            return;
        }
        processUploadedFiles(target.files)
    }

    function setupListeners() {
        // file uploader
        let fileInput = document.getElementById("file-upload");
        fileInput.addEventListener("change", (event) => {
            onUploadListener(event)
        });

        // folder uploader
        let folderInput = document.getElementById("folder-upload");
        folderInput.addEventListener("change", (event) => {
            onUploadListener(event)
        });

        //keybindings table
        let addKeybindingButton = document.getElementById("add-keybinding-button")
        addKeybindingButton.addEventListener("click", () => addNewKeybinding())
        let clearKeybindingsButton = document.getElementById("clear-keybindings-button")
        clearKeybindingsButton.addEventListener("click", () => clearKeybindings())

        //testing / example values loader buttons
        let exampleKeybindingsButton = document.getElementById("example-keybindings-button")
        exampleKeybindingsButton.addEventListener("click", () => {
            setExampleKeybindings()
        })
        let exampleImagesButton = document.getElementById("example-images-button")
        exampleImagesButton.addEventListener("click", async () => {
            await loadExampleImages()
        })
        let clearStorageButton = document.getElementById("clear-storage-button")
        clearStorageButton.addEventListener("click", () => {
            clearStorage()
        })

        document.addEventListener("keydown", event => {
            applyKeybindingByKey(event.key)
        })
    }


    function setupLocalStorageBindings() {
        Storage.prototype.setObject = function (key, value) {
            this.setItem(key, JSON.stringify(value));
        }
        Storage.prototype.getObject = function (key) {
            let value = this.getItem(key);
            return value && JSON.parse(value);
        }
        // keybindings: an array of objects, where each object is a keybinding object with attributes: key, folder
        Storage.prototype.getKeybindings = function () {
            return localStorage.getObject("keybindings") || []
        }
        Storage.prototype.setKeybindings = function (keybindings) {
            return localStorage.setObject("keybindings", keybindings)
        }
        // mappings: an object where each key is a filename, with as value the folder it needs to be moved to
        Storage.prototype.getMappings = function () {
            return localStorage.getObject("mappings") || {}
        }
        Storage.prototype.setMappings = function (mappings) {
            return localStorage.setObject("mappings", mappings)
        }
        // filename: a string of the name of the file the gallery is currently showing / where the gallery last left off
        Storage.prototype.getFilename = function () {
            return localStorage.getItem("filename")
        }
        Storage.prototype.setFilename = function (filename) {
            return localStorage.setItem("filename", filename)
        }
        // index: an int of the index of the item gallery, FALLBACK for filename
        Storage.prototype.getIndex = function () {
            return parseInt(localStorage.getItem("index") || 0)
        }
        Storage.prototype.setIndex = function (index) {
            return localStorage.setItem("index", index)
        }
        // uploads: an array of file objects from the upload form, so each file object has a name, mime type, etc
        Storage.prototype.getUploads = function () {
            return localStorage.getObject("uploads") || []
        }
        Storage.prototype.setUploads = function (uploads) {
            return localStorage.setObject("uploads", uploads)
        }

    }

    function setExampleKeybindingsOnFirstVisit() {
        if (localStorage.getObject("keybindings") === null) {
            localStorage.setKeybindings(getExampleKeybindings())
        }
    }

    function onLoad() {
        setupLocalStorageBindings()
        setExampleKeybindingsOnFirstVisit()
        loadKeybindingTable()
        setupListeners()
    }

    const toggleButton = document.getElementById('open-tests-button');
    const expandedSection = document.getElementById('test-section');

    toggleButton.addEventListener('click', function () {
        if (expandedSection.style.display === 'none') {
            expandedSection.style.display = 'block';
        }
        else {
            expandedSection.style.display = 'none';
        }
    });

    const dragTarget = document.getElementById('drag-target');

    document.addEventListener('dragenter', function (event) {
        dragTarget.classList.add('show');
    });

    document.addEventListener('dragleave', function (event) {
        dragTarget.classList.remove('show');
    });

    document.addEventListener('dragover', function (event) {
        event.preventDefault();
    });

    document.addEventListener('drop', function (event) {
        event.preventDefault();
        dragTarget.classList.remove('show');
        console.log(event)
        if (event.dataTransfer.files.length === 0){
            logToUser("No files dropped.")
            return;
        }
        processUploadedFiles(event.dataTransfer.files)
    });

    onLoad();

</script>
</html>

